# edb-deployment tests

This folder contains all the necessary material needed to execute
`edb-deployment` functional tests.

## Requirements

1. This test suite relies on `docker` containers and requires to have a working
`docker` environment and the `docker compose` command working.

2. Cloud credentials. Executing tests involves machine provisioning in Cloud,
thus, before running the tests, we need to login to target Cloud platform.
Please refer to [Configure Cloud Credentials](../README.md#configure-cloud-credentials)

## Coverage (2021-09-24)

### aws

| Command | `EDB-RA1` | `EDB-RA-2` | `EDB-RA-3` |
| --- | --- | --- | --- |
| `aws setup` | yes | yes | yes |
| `aws configure` | yes | yes | yes |
| `aws provision` | yes | yes | yes |
| `aws deploy` | yes | yes | yes |
| `aws destroy` | yes | yes | yes |
| `aws remove` | yes | yes | yes |
| `aws list` | no | no | no |
| `aws display` | no | no | no |
| `aws show` | no | no | no |
| `aws passwords` | no | no | no |
| `aws logs` | no | no | no |
| `aws ssh` | no | no | no |

### azure

| Command | `EDB-RA1` | `EDB-RA-2` | `EDB-RA-3` |
| --- | --- | --- | --- |
| `azure setup` | yes | yes | yes |
| `azure configure` | yes | yes | yes |
| `azure provision` | yes | yes | yes |
| `azure deploy` | yes | yes | yes |
| `azure destroy` | yes | yes | yes |
| `azure remove` | yes | yes | yes |
| `azure list` | no | no | no |
| `azure display` | no | no | no |
| `azure show` | no | no | no |
| `azure passwords` | no | no | no |
| `azure logs` | no | no | no |
| `azure ssh` | no | no | no |

### gcloud

| Command | `EDB-RA1` | `EDB-RA-2` | `EDB-RA-3` |
| --- | --- | --- | --- |
| `gcloud setup` | no | no | no |
| `gcloud configure` | no | no | no |
| `gcloud provision` | no | no | no |
| `gcloud deploy` | no | no | no |
| `gcloud destroy` | no | no | no |
| `gcloud remove` | no | no | no |
| `gcloud list` | no | no | no |
| `gcloud display` | no | no | no |
| `gcloud show` | no | no | no |
| `gcloud passwords` | no | no | no |
| `gcloud logs` | no | no | no |
| `gcloud ssh` | no | no | no |

## Execution

Functional test suite can be executed by running the `run.sh` script. Several
environment variables are available and can be used to configure the test
environment.

### Environment variables

| Variable | Description | Default value |
| --- | --- | --- |
| `EDB_DEPLOY_CLOUD_VENDOR` | Cloud vendor code name: `aws` or `azure` | `aws` |
| `EDB_DEPLOY_CLOUD_REGION` | Cloud vendor region where the machines will be located. | `us-east-2` |
| `EDB_DEPLOY_PG_TYPE` | Database engine: `PG` or `EPAS` | `PG` |
| `EDB_DEPLOY_PG_VERSION` | Database engine major version: `13`, `12`, etc.. | `13` |
| `EDB_DEPLOY_RA` | Reference architecture: `EDB-RA-1`, `EDB-RA-2` or `EDB-RA-3` | `EDB-RA-1` |
| `EDB_DEPLOY_EDB_CREDENTIALS` | EDB package repoisory credentials | `user:password` |
| `EDB_DEPLOY_EFM_VERSION` | EFM version | `4.2` |

### Example

For example, executing the tests on a `EDB-RA-2` architecture using EPAS and
deployed on AWS:

```console
$ export EDB_DEPLOY_CLOUD_VENDOR=aws
$ export EDB_DEPLOY_PG_TYPE=EPAS
$ export EDB_DEPLOY_RA=EDB-RA-2
$ export EDB_DEPLOY_EDB_CREDENTIALS="<username>:<password>"
$ ./run.sh
```

Running tests in the same configuration but on Azure:

```console
$ export EDB_DEPLOY_CLOUD_VENDOR=azure
$ export EDB_DEPLOY_CLOUD_REGION=eastus2
$ export EDB_DEPLOY_PG_TYPE=EPAS
$ export EDB_DEPLOY_RA=EDB-RA-2
$ export EDB_DEPLOY_EDB_CREDENTIALS="<username>:<password>"
$ ./run.sh
```

### py.test output

Below is an example of the output generated by `py.test` when running the
`EDB-RA-1` tests on AWS:
```console
test-aws_1  | + py.test -o log_file=/workspace/tests/pytest.log -o log_file_level=INFO -v /workspace/tests/test_edb-deployment.py
test-aws_1  | ============================= test session starts ==============================
test-aws_1  | platform linux -- Python 3.6.8, pytest-6.2.5, py-1.10.0, pluggy-1.0.0 -- /usr/bin/python3
test-aws_1  | cachedir: .pytest_cache
test-aws_1  | rootdir: /workspace
test-aws_1  | plugins: testinfra-6.4.0
test-aws_1  | collecting ... collected 15 items
test-aws_1  |
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_configure_project_dir PASSED [  6%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_configure_project_structure PASSED [ 13%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_configure_ansible_vars PASSED [ 20%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_configure_terraform_vars PASSED [ 26%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_configure_ssh PASSED [ 33%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_provision_state_json PASSED [ 40%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_provision_inventory_yml PASSED [ 46%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_provision_ssh_machines PASSED [ 53%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_deploy_primary PASSED [ 60%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_deploy_pemagent PASSED [ 66%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_deploy_pemserver PASSED [ 73%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_deploy_barmanserver PASSED [ 80%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_deploy_standbys SKIPPED [ 86%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_deploy_efm SKIPPED [ 93%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_deploy_pgpool2 SKIPPED [100%]
test-aws_1  |
test-aws_1  | ================== 12 passed, 3 skipped in 630.65s (0:10:30) ===================
test-aws_1 exited with code 0
```

### Logs

Log entries produced by `edb-deployment` during tests execution are stored in
the `pytest.log` file.
