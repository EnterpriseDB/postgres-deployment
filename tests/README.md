# edb-deployment tests

This folder contains all the necessary material needed to execute
`edb-deployment` functional tests.

## Requirements

1. This test suite relies on `docker` containers and requires to have a working
`docker` environment and the `docker compose` command working.

2. Cloud credentials. Executing tests involves machine provisioning in Cloud,
thus, before running the tests, we need to login to target Cloud platform.
Please refer to [Configure Cloud Credentials](../README.md#configure-cloud-credentials)

## Coverage (2021-09-24)

### aws

| Command | `EDB-RA1` | `EDB-RA-2` | `EDB-RA-3` |
| --- | --- | --- | --- |
| `aws setup` | yes | yes | yes |
| `aws configure` | yes | yes | yes |
| `aws provision` | yes | yes | yes |
| `aws deploy` | yes | yes | yes |
| `aws destroy` | yes | yes | yes |
| `aws remove` | yes | yes | yes |
| `aws list` | no | no | no |
| `aws display` | no | no | no |
| `aws show` | no | no | no |
| `aws passwords` | no | no | no |
| `aws logs` | no | no | no |
| `aws ssh` | no | no | no |

### azure

| Command | `EDB-RA1` | `EDB-RA-2` | `EDB-RA-3` |
| --- | --- | --- | --- |
| `azure setup` | yes | yes | yes |
| `azure configure` | yes | yes | yes |
| `azure provision` | yes | yes | yes |
| `azure deploy` | yes | yes | yes |
| `azure destroy` | yes | yes | yes |
| `azure remove` | yes | yes | yes |
| `azure list` | no | no | no |
| `azure display` | no | no | no |
| `azure show` | no | no | no |
| `azure passwords` | no | no | no |
| `azure logs` | no | no | no |
| `azure ssh` | no | no | no |

### gcloud

| Command | `EDB-RA1` | `EDB-RA-2` | `EDB-RA-3` |
| --- | --- | --- | --- |
| `gcloud setup` | yes | yes | yes |
| `gcloud configure` | yes | yes | yes |
| `gcloud provision` | yes | yes | yes |
| `gcloud deploy` | yes | yes | yes |
| `gcloud destroy` | yes | yes | yes |
| `gcloud remove` | yes | yes | yes |
| `gcloud list` | no | no | no |
| `gcloud display` | no | no | no |
| `gcloud show` | no | no | no |
| `gcloud passwords` | no | no | no |
| `gcloud logs` | no | no | no |
| `gcloud ssh` | no | no | no |

## Execution

Functional test suite can be executed by running the `run.sh` script. Several
environment variables are available and can be used to configure the test
environment.

### Environment variables

| Variable | Description | Default value |
| --- | --- | --- |
| `EDB_DEPLOY_CLOUD_VENDOR` | Cloud vendor code name: `aws` or `azure` or `gcloud` | `aws` |
| `EDB_DEPLOY_CLOUD_REGION` | Cloud vendor region where the machines will be located. | `us-east-2` |
| `EDB_DEPLOY_PG_TYPE` | Database engine: `PG` or `EPAS` | `PG` |
| `EDB_DEPLOY_PG_VERSION` | Database engine major version: `14`, `13`, `12`, etc.. | `14` |
| `EDB_DEPLOY_RA` | Reference architecture: `EDB-RA-1`, `EDB-RA-2` or `EDB-RA-3` | `EDB-RA-1` |
| `EDB_DEPLOY_EDB_CREDENTIALS` | EDB package repoisory credentials | `user:password` |
| `EDB_GOOGLE_ACCOUNTS_FILE` | GCloud service account Json file | `~/accounts.json` |
| `EDB_GCLOUD_PROJECT_ID` | GCloud project id | `project_id` |

### Example

For example, executing the tests on a `EDB-RA-2` architecture using EPAS and
deployed on AWS:

```console
$ export EDB_DEPLOY_CLOUD_VENDOR=aws
$ export EDB_DEPLOY_PG_TYPE=EPAS
$ export EDB_DEPLOY_RA=EDB-RA-2
$ export EDB_DEPLOY_EDB_CREDENTIALS="<username>:<password>"
$ ./run.sh
```

Running tests in the same configuration but on Azure:

```console
$ export EDB_DEPLOY_CLOUD_VENDOR=azure
$ export EDB_DEPLOY_CLOUD_REGION=eastus2
$ export EDB_DEPLOY_PG_TYPE=EPAS
$ export EDB_DEPLOY_RA=EDB-RA-2
$ export EDB_DEPLOY_EDB_CREDENTIALS="<username>:<password>"
$ ./run.sh
```

Running tests in the same configuration but on GCloud:
```console
$ export EDB_DEPLOY_CLOUD_VENDOR=gcloud
$ export EDB_DEPLOY_CLOUD_REGION=us-east1
$ export EDB_DEPLOY_PG_TYPE=EPAS
$ export EDB_DEPLOY_RA=EDB-RA-2
$ export EDB_DEPLOY_EDB_CREDENTIALS="<username>:<password>"
$ export EDB_GOOGLE_ACCOUNTS_FILE=~/accounts.json
$ export EDB_GCLOUD_PROJECT_ID=project_id
$ ./run.sh
```
### py.test output

Below is an example of the output generated by `py.test` when running the
`EDB-RA-1` tests on AWS:
```console
test-aws_1  | + py.test -o log_file=/workspace/tests/pytest.log -o log_file_level=INFO -v /workspace/tests/test_edb-deployment.py
test-aws_1  | ============================= test session starts ==============================
test-aws_1  | platform linux -- Python 3.6.8, pytest-6.2.5, py-1.10.0, pluggy-1.0.0 -- /usr/bin/python3
test-aws_1  | cachedir: .pytest_cache
test-aws_1  | rootdir: /workspace
test-aws_1  | plugins: testinfra-6.4.0
test-aws_1  | collecting ... collected 15 items
test-aws_1  |
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_configure_project_dir PASSED [  6%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_configure_project_structure PASSED [ 13%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_configure_ansible_vars PASSED [ 20%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_configure_terraform_vars PASSED [ 26%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_configure_ssh PASSED [ 33%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_provision_state_json PASSED [ 40%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_provision_inventory_yml PASSED [ 46%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_provision_ssh_machines PASSED [ 53%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_deploy_primary PASSED [ 60%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_deploy_pemagent PASSED [ 66%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_deploy_pemserver PASSED [ 73%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_deploy_barmanserver PASSED [ 80%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_deploy_standbys SKIPPED [ 86%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_deploy_efm SKIPPED [ 93%]
test-aws_1  | tests/test_edb-deployment.py::TestEDBDeployment::test_deploy_pgpool2 SKIPPED [100%]
test-aws_1  |
test-aws_1  | ================== 12 passed, 3 skipped in 630.65s (0:10:30) ===================
test-aws_1 exited with code 0
```

### Logs

Log entries produced by `edb-deployment` during tests execution are stored in
the `pytest.log` file.

## Testing BDR PoT

### Using TPAexec

In order to execute BDR PoT tests, TPAexec sources (git clone) directory must
be present on the host system. The testing framework installs TPAexec on the
container environment from these sources, then, using a specific version
consists in checking out the corresponding git tag.

Example: using the v22.8 version

```shell
$ cd tpaexec
$ git fetch --all --tags
$ git checkout tags/v22.8 -b v22.8
```

### Variables

Fallowing are the BDR PoT variables.

| Variable | Description | Default value |
| --- | --- | --- |
| `EDB_POT_R53_ACCESS_KEY` | AWS Route53 access key |  |
| `EDB_POT_R53_SECRET` | AWS Route53 secret |  |
| `EDB_POT_EMAIL_ID` | User email address |  |
| `EDB_POT_TPAEXEC_SUBSCRIPTION_TOKEN` | TPAexec subscription token |  |
| `EDB_POT_TPAEXEC_SRC_PATH` | TPAexec source directory (full path) |  |

### Coverage

The following points are checked during tests execution:
- project creation
- project structure
- Ansible variables
- Terraform variables
- SSH configuration
- Ansible inventory file
- SSH connection to the machines
- Postgres is up and running on the BDR nodes
- PEM agent is installed, configured and running on BDR and pgbouncer nodes
- PEM server is installed, configured and running
- Barman works (`barman check`) for each location
- harp-proxy and pgbouncer are running on the pooler nodes
- BDR lead master nodes are harp cluster leaders
- Postgres connection to harp-proxy works and redirects to right BDR lead
  master node.

### Running the tests

To ease variables configuration, we recommend to define them in a dedicated
file named `.env-bdr-pot`.

Example for the EDB-Always-On-Silver architecture:
```bash
# Must be set to EPAS
export EDB_DEPLOY_PG_TYPE=EPAS
# Must be set to 14
export EDB_DEPLOY_PG_VERSION=14
export EDB_DEPLOY_PROJECT_NAME=testbdr
export EDB_DEPLOY_RA=EDB-Always-On-Silver
export EDB_DEPLOY_EDB_CREDENTIALS="<edb-repo-username>:<edb-repo-password>"
export EDB_DEPLOY_CLOUD_REGION=us-east-2
export EDB_POT_R53_ACCESS_KEY=<aws-route53-access-key>
export EDB_POT_R53_SECRET=<aws-route53-secret>
export EDB_POT_EMAIL_ID=user@mail.com
export EDB_POT_TPAEXEC_SUBSCRIPTION_TOKEN=<tpaexec-subscription-token>
export EDB_POT_TPAEXEC_SRC_PATH=/Users/julien/Work/Development/tpaexec
```

Enable those variables with:
```shell
$ source ./.env-bdr-pot
```

and then, start the execution of the test with:
```shell
$ ./run.sh
```

### Tests execution timing

Running the tests for the *EDB-Always-On-Silver* architecture takes 40 minutes,
testing the Platinum architecture takes 1 hour.
