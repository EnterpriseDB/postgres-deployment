---
# tasks file for pov_setup

# Reference EPAS Variables
- name: Reference EPAS Variables
  include_vars: "{{ pg_type }}.yml"

- name: Verify Variables
  import_tasks: verify_variables.yml
  
- name: Set pem_server_private_ip, pem_server_public_ip
  set_fact:
    pem_server_public_ip: "{{ node.ansible_host }}"
    pem_server_private_ip: "{{ node.private_ip }}"
  loop: "{{ lookup('edb_devops.edb_postgres.pem_server', wantlist=True) }}"
  loop_control:
    loop_var: node
  when:  node.node_type == 'pemserver'
  no_log: "{{ disable_logging }}"

- name: Iterate over set_variable
  include_tasks: pg_hba_rule.yml
  loop: "{{ lookup('edb_devops.edb_postgres.pg_sr_cluster_nodes', wantlist=True) }}"
  loop_control:
    loop_var: node
  no_log: "{{ disable_logging }}"

- name: Run script and create pg user
  block:
    - import_tasks: pg_create_user.yml
    - import_tasks: pg_pot_scripts.yml
  when: group_names | select('search','primary') | list | count > 0

- name: Calling the pot_setup.ym
  include_tasks: pot_setup.yml

- name: Update route53
  import_tasks: update_route53.yml
  when: group_names | select('search','primary') | list | count > 0

- name: Update pem server
  block:
    - import_tasks: pem_server_certs.yml
    - import_tasks: pem_server_probe_alert.yml
  when: group_names | select('search','pemserver') | list | count > 0
